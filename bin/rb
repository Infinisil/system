#!/usr/bin/env nix-shell
#!nix-shell -i bash -p nixops git

set -e

# Give the opportunity to commit
if [[ $(git -C /cfg diff --shortstat) != "" ]]; then
	if [[ "$1" == "a" ]]; then
		shift
		git -C /cfg commit -p -v --amend || true
	else
		git -C /cfg commit -p -v || true
	fi
fi

# If the first argument is b, just build
if [ "$1" = "b" ]; then
	shift
	echo Only building..
	build="--build-only"
else
	echo Building and activating..
fi

# evaluate dirty status
if [[ $(git -C /cfg diff --shortstat) != "" ]]; then
	dirty=true
else
	dirty=false
fi

sudo nixops set-args -d infinisil --arg dirty "$dirty"
sudo nixops deploy -d infinisil $build $@
