#!/usr/bin/env bash

set -e

# Give the opportunity to commit
if [[ $(git -C /cfg diff --shortstat) != "" ]]; then
	if [[ "$1" == "a" ]]; then
		shift
		git -C /cfg commit -p -v --amend || true
	else
		git -C /cfg commit -p -v || true
	fi
fi

# If the first argument is b, just build
if [ "$1" = "b" ]; then
	shift
	echo Only building..
	build="--build-only"
else
	echo Building and activating..
fi

# evaluate dirty status
if [[ $(git -C /cfg diff --shortstat) != "" ]]; then
	label=$(printf "%.7s-dirty-%.35s" \
		"$(nix-hash /cfg --base32)" \
		"$(git -C /cfg log --pretty=format:'%h-%f' -n 1)")
else
	label=$(printf "%.35s" \
		"$(git -C /cfg log --pretty=format:'%h-%f' -n 1)")
fi



sudo @nixops@ set-args -d infinisil --argstr label "$label"
sudo @nixops@ deploy -d infinisil $build $@
